# 修改地方：
1. ESS改成20年，这样阶段就会减少1个，现在是4个阶段（没用，重新改回去了）
2. 规划终止阶段改为2030年，变成单阶段（无解）
3. 将约束部分的192-656全都注释掉之后，变成Model is unbounded，也就是约束过于松弛



## 单阶段下常见不可行原因分析

你将`end_year`改为2030后，模型变成**单阶段**，且理论上不涉及设备退役，但依然出现“模型不可行（infeasible）”的问题。  
这说明**问题并非由多阶段、设备退役或跨阶段储能约束引起**，而是**单阶段下的参数或约束本身存在矛盾**。


### 1. **负荷与设备能力不匹配**
- 负荷数据（电、热）是否远大于所有设备最大能力之和？
- 设备最大容量（如CCGT、PV、WT、EBg、HPg等）是否设置过小？

### 2. **储能容量或充放电能力过小**
- `ESS.cap_max`、`TES.cap_max`是否太小，无法平衡负荷波动？
- `str_max`（充放电倍率）是否太小，导致储能无法及时充放电？

### 3. **储能SOC/SOT上下限设置过于严格**
- `cap_min_ratio`、`cap_max_ratio`是否都为1或接近1，导致SOC/SOT只能等于容量，灵活性极低？
- SOC/SOT周期性约束（始末差异5%）在容量极小时，实际可用范围极窄。

### 4. **输入数据异常**
- `output-avg.xlsx`中的负荷、可再生出力等数据是否有缺失、极端值或全为0？

### 5. **平衡约束过于严格**
- 电力/热力平衡约束是否没有松弛变量，或者松弛变量上限太小？

### 6. **变量上下界设置冲突**
- 某些变量的下界大于上界，或容量变量被强制为0但又要求有输出。

---

## 针对你的情况的排查建议

### 1. **重点检查参数设置**
请重点检查`parameters.m`中如下参数：
- `params.technical.CCGT.P_max`、`PV.P_max`、`WT.P_max`、`EBg.Q_max`、`HPg.Q_max`等设备最大容量
- `params.technical.ESS.cap_max`、`TES.cap_max`（储能最大容量）
- `params.technical.ESS.str_max`、`TES.str_max`（充放电倍率）
- `params.technical.ESS.cap_min_ratio`、`cap_max_ratio`、`TES.cap_min_ratio`、`cap_max_ratio`
- `params.input.n`（典型日数量，影响年化因子和负荷）

### 2. **检查输入数据**
- 打开`output-avg.xlsx`，确认负荷数据（电、热）是否合理，且与设备能力匹配。

### 3. **尝试放宽储能相关约束**
- 临时将`cap_min_ratio`设为0，`cap_max_ratio`设为1，`str_max`设为1（即充放电功率等于容量），看模型是否可行。
- 放宽SOC/SOT周期性约束（如允许10%差异）。

### 4. **检查平衡约束松弛变量**
- 确认`build_constraints.m`中电力、热力平衡约束的松弛变量上限是否足够大。

### 5. **极简测试法**
- 临时将所有设备最大容量、储能容量、充放电倍率都设为很大（如10000），看模型是否可行。如果可行，说明是能力不足导致不可行。

---

## 结论

**单阶段下不可行，99%是参数设置或输入数据与约束矛盾**，而不是代码结构问题。  
建议优先检查设备能力、储能参数、负荷数据和松弛变量设置。

---

### 如果你需要更具体的帮助，请补充：
- `parameters.m`中**储能和主要设备参数**部分内容
- `output-avg.xlsx`中**负荷数据**的典型数值
- 或将`build_constraints.m`中**储能相关约束**和**平衡约束**部分贴出

这样我可以帮你更精确地定位问题！

---


## 一、问题本质

- **Gurobi报错“infeasible or unbounded”**，说明你构建的优化模型在当前参数和约束下，没有任何可行解（即没有任何变量组合能同时满足所有约束），或者目标函数没有下界（无界）。
- 但在实际工程能源系统建模中，绝大多数情况下是“不可行”而不是“无界”。

---

## 二、项目结构与建模流程回顾

1. **参数加载**：`parameters.m` 设定了所有经济、技术、时间、阶段等参数。
2. **变量定义**：`define_variables.m` 定义了所有优化变量。
3. **约束构建**：`build_constraints.m` 构建了所有运行、容量、平衡、跨阶段等约束。
4. **目标函数**：`build_objective.m` 构建了总成本目标。
5. **求解**：`solve_optimization.m` 调用Gurobi求解。
6. **结果处理**：`process_results.m`等处理和可视化。

---

## 三、常见导致“不可行”的原因

### 1. **输入数据或参数设置不合理**
- 负荷数据、可再生出力、设备参数、价格等输入数据有误或极端（如负荷远大于设备最大能力）。
- 某些参数为0或负数，导致约束无解。

### 2. **约束条件过于严格或矛盾**
- 设备容量上限太低，无法满足负荷。
- 储能初始/终止状态设置不合理。
- 跨阶段约束、启停约束、平衡约束等有逻辑冲突。
- 某些变量的上下界设置错误（如负数容量、负数功率等）。

### 3. **时间/阶段划分与数据维度不匹配**
- 时间步数、阶段数与输入数据长度不一致，导致索引越界或数据缺失。
- 典型日权重、年化因子等参数设置不合理。

### 4. **输入文件（如output-avg.xlsx）内容异常**
- Excel文件缺失、格式错误、数据缺失或单位不一致。

---

## 四、结合你的运行日志，重点排查建议

1. **参数和阶段划分看似正常**  
   日志显示阶段划分、碳价、电价、设备寿命等都已正确输出，说明`parameters.m`基本无大错。

2. **约束构建阶段未报错**  
   说明变量和约束的基本结构是对的，但不代表内容合理。

3. **模型规模极大**  
   2367万行约束、33万变量，说明时间步数、阶段数、设备种类都较多，任何一个小的参数错误都可能导致不可行。

4. **求解器直接判定不可行**  
   说明在预处理阶段就发现无解，通常是硬性约束矛盾。

---

## 五、具体排查建议

### 1. **检查负荷与设备能力**
- 检查`parameters.m`中各类设备的最大容量（如`P_max_CCGT`、`PV_max`等）是否足以覆盖负荷峰值。（没问题）
- 检查`output-avg.xlsx`中的负荷数据是否异常大或为0。（没问题）

### 2. **检查储能相关约束**
- 储能SOC/SOT初始和终止状态是否设置过于严格（如必须满电、但容量又太小）。
- 跨阶段储能约束是否有矛盾。

### 3. **检查变量上下界**
- 所有变量（容量、功率等）是否有合理的下界（如≥0）和上界。

### 4. **检查平衡约束**
- 电力、热力平衡方程是否有遗漏或系数错误，导致无法平衡。

### 5. **检查输入文件**
- 打开`output-avg.xlsx`，确认所有sheet和数据单元格无缺失、无异常值。

### 6. **利用诊断工具**
- 你可以在`solve_optimization.m`中启用YALMIP的`diagnose`功能，或在Gurobi中导出IIS（不可行约束集），定位具体不可行的约束。

---

## 六、快速定位技巧

- **缩小规模测试**：将阶段数、时间步数、负荷等参数调小，先跑一个极简模型，逐步恢复复杂度，观察何时变为不可行。
- **注释部分约束**：逐步注释掉部分约束（如储能、启停、跨阶段等），看是否可行，逐步定位问题。
- **打印关键参数**：在`main.m`和`parameters.m`中打印所有关键参数和输入数据的最大/最小值。

---

## 七、结论

你的模型“不可行”**99%是参数或约束设置矛盾**，而不是代码结构性错误。建议优先检查：
- 负荷与设备能力的匹配
- 储能和跨阶段约束
- 输入数据完整性

如需进一步定位，请提供`parameters.m`关键参数、`output-avg.xlsx`的负荷数据样例，或将`build_constraints.m`的主要约束内容贴出，我可以帮你更精确地定位问题。
