# 多阶段规划程序结构说明

## 程序总体结构

该程序实现了一个多阶段能源系统优化规划模型，主要由以下几个关键模块组成：

1. `main.m` - 主函数，控制整个优化流程
2. `parameters.m` - 参数定义和初始化
3. `define_variables.m` - 定义优化变量
4. `build_constraints.m` - 构建各阶段约束条件
5. `build_objective.m` - 构建目标函数

## 函数调用关系

### 主函数 `main.m`

主函数是程序的入口点，负责协调整个多阶段优化过程：

1. 首先调用 `parameters()` 获取系统参数
2. 调用 `define_variables(params)` 定义全局优化变量
3. 构建全局约束：
   - 对每个阶段 s，调用 `build_constraints(all_variables, params, s)` 构建该阶段的运行约束
   - 添加跨阶段容量演化约束（设备容量传递、新增容量非负约束等）
4. 构建全局目标函数：
   - 对每个阶段 s，调用 `build_objective(all_variables, params, s)` 构建该阶段的目标函数
   - 应用折现因子，累加得到总目标函数
5. 求解优化问题并处理结果

### 参数初始化 `parameters.m`

该函数负责初始化所有系统参数，包括：

1. 基本设置（求解参数、输入数据等）
2. 技术参数（各种设备的技术特性）
3. 多阶段规划参数（阶段划分、各阶段年数等）
4. 经济参数（投资成本、运维成本、燃料价格等）
5. 环境参数（碳排放因子等）
6. 时间序列数据（负荷、可再生能源出力等）

特别地，多阶段规划参数中：
- 根据设备寿命自动计算规划阶段划分
- 为每个阶段生成相应的负荷和可再生能源时间序列
- 设置各阶段的碳价和电价趋势

### 变量定义 `define_variables.m`

该函数定义了所有优化变量，包括：

1. 投资决策变量（各阶段的设备装机容量）
2. 运行变量（各阶段的设备出力、启停状态等）
3. 储能变量（各阶段的充放电功率、能量状态等）

变量维度说明：
- 投资决策变量维度为 `[s, 1]`，表示各阶段的装机容量
- 运行变量维度为 `[t, s]` 或 `[clm_onoff_*, s]`，表示各阶段的时间序列数据
- 储能状态变量维度为 `[t+1, s]`，表示各阶段的储能状态（包括初始和最终状态）

### 约束构建 `build_constraints.m`

该函数为每个阶段构建约束条件，包括：

1. 运行约束（设备出力上下限、爬坡约束等）
2. 平衡约束（电力平衡、热力平衡）
3. 设备约束（启停逻辑、最小启停时间等）
4. 储能约束（充放电功率限制、能量平衡等）

特别注意：
- 该函数处理单个阶段的约束，通过 `stage` 参数指定当前处理的阶段
- 使用 `current_stage_time_steps` 获取当前阶段的时间步数
- 对于开关周期相关的约束，使用 `map_onoff_to_t_*` 映射开关周期到时间步

### 目标函数构建 `build_objective.m`

该函数为每个阶段构建目标函数，包括：

1. 投资成本（当前阶段的新增投资）
2. 燃料成本（天然气消耗成本）
3. 运维成本（固定运维和可变运维）
4. 爬坡成本和启停成本
5. 电网交互成本（购电成本减去售电收益）
6. 碳排放成本

特别注意：
- 该函数处理单个阶段的目标函数，通过 `stage` 参数指定当前处理的阶段
- 应用阶段折现因子，将未来成本折现到当前
- 使用年化因子和阶段因子，将典型日数据扩展到整个阶段

## 多阶段规划实现方式

该程序通过以下方式实现多阶段规划：

1. **统一求解方法**：将所有阶段的变量、约束和目标函数集成到一个大规模优化问题中，一次性求解
2. **阶段连接约束**：通过容量传递约束（如 `variables.CCGT.n(s) == variables.CCGT.n(s-1) + variables.CCGT.n_new(s)`）实现阶段间的连接
3. **阶段特定参数**：为每个阶段设置不同的参数（如负荷增长、碳价变化等）
4. **折现处理**：对不同阶段的成本进行折现，反映时间价值

这种方法的优点是可以考虑长期规划视角下的各阶段之间的相互影响，得到全局最优解。

## 风光不确定性的处理

程序中通过以下方式处理风光不确定性：

1. 使用典型日数据表示风光资源的时间序列特性
2. 在不同阶段设置不同的可再生能源潜力增长率
3. 通过平衡约束中的松弛变量处理可能的供需不平衡
4. 储能系统的引入增强了系统应对风光不确定性的能力

## 总结

该多阶段规划程序通过一体化求解方法，将长期规划问题分解为多个相互关联的阶段，同时考虑了各阶段之间的连续性约束和时间价值，实现了能源系统的长期优化规划。程序结构清晰，各模块功能明确，便于维护和扩展。 